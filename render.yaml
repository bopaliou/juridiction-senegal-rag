# Configuration Render.com pour YoonAssist
# Déploiement automatique du backend et frontend

services:
  # ============================================================================
  # BACKEND - API FastAPI Python (Optimisé pour 512MB Render free tier)
  # ============================================================================
  - type: web
    name: yoonassist-backend
    env: python
    region: oregon
    plan: free
    branch: main
    buildCommand: |
      pip install --upgrade pip wheel
      pip install -r requirements.txt --no-cache-dir
      echo "✅ Build complet"
    startCommand: |
      python -c "import gc; gc.collect()" && \
      exec uvicorn src.server:app \
        --host 0.0.0.0 \
        --port $PORT \
        --workers 1 \
        --loop uvloop \
        --timeout-keep-alive 60
    healthCheckPath: /health
    envVars:
      - key: GROQ_API_KEY
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: REQUEST_TIMEOUT
        value: "60"
      - key: MAX_WORKERS
        value: "1"
      - key: ALLOWED_ORIGINS
        value: "https://yoonassist-frontend.onrender.com"
      - key: PYTHON_VERSION
        value: "3.11.0"
      - key: DATA_PATH
        value: "./data"
      - key: DATA_DB_PATH
        value: "./data/chroma_db"
      # Optimisations mémoire pour 512MB free tier
      - key: OMP_NUM_THREADS
        value: "1"
      - key: OPENBLAS_NUM_THREADS
        value: "1"
      - key: MKL_NUM_THREADS
        value: "1"
      - key: NUMEXPR_NUM_THREADS
        value: "1"
      - key: TF_CPP_MIN_LOG_LEVEL
        value: "3"
      - key: TRANSFORMERS_CACHE
        value: "/tmp/transformers_cache"
      - key: SENTENCE_TRANSFORMERS_CACHE_FOLDER
        value: "/tmp/st_cache"
      - key: WEB_CONCURRENCY
        value: "1"
      - key: PYTHONUNBUFFERED
        value: "1"

  # ============================================================================
  # FRONTEND - Next.js 16
  # ============================================================================
  - type: web
    name: yoonassist-frontend
    env: node
    region: oregon
    plan: free
    branch: main
    rootDir: legal-rag-frontend
    buildCommand: npm ci && npm run build
    startCommand: npm start
    envVars:
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      - key: NEXT_PUBLIC_API_URL
        fromService:
          type: web
          name: yoonassist-backend
          envVarKey: RENDER_EXTERNAL_URL
      - key: NODE_ENV
        value: production
